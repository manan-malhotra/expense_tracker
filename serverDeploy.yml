- name: Kubernetes
  hosts: remote
  remote_user: yashtalele
  vars:
      ansible_python_interpreter: /usr/bin/python3
      ansible_user: yashtalele
      ansible_password: yash@#97
  tasks:
      - name: Login in docker hub with user
        community.general.docker_login:
            username: manan80malhotra
            password: Adyybfkc1!
      - name: Delete pods if running2
        ansible.builtin.shell: /usr/local/bin/kubectl delete -f /Users/yashtalele/expense_tracker/server/kubernetes.yml
        ignore_errors: true
      - name: Delete Docker image
        community.general.docker_image:
            name: manan80malhotra/expense_tracker
            tag: latest
            state: absent
      - name: Build Docker image
        community.general.docker_image:
            name: manan80malhotra/expense_tracker
            tag: latest
            source: build
            build:
                path: /Users/yashtalele/expense_tracker/server/
                dockerfile: Dockerfile
      - name: Push Docker image to Docker Hub
        community.general.docker_image:
            name: manan80malhotra/expense_tracker
            tag: latest
            push: yes
            source: local
      - name: Install Helm
        command: /opt/homebrew/bin/brew install helm
      - name: Install ngrok Ingress Controller & Creating namespace
        ansible.builtin.shell: /opt/homebrew/bin/helm install ngrok-ingress-controller ngrok/kubernetes-ingress-controller --namespace ngrok-ingress-controller --create-namespace --set credentials.apiKey=2erQPatj59x7iKJF7cGf0HwCLsw_3RNt8gVAUjnbQ964gsrvA --set credentials.authtoken=2eiEeEZ1L0WTexLPz74H09KRIim_2os4KoFhZbb1UZScjg97m
        ignore_errors: true
      - name: Delete pods if running
        ansible.builtin.shell: /usr/local/bin/kubectl delete -f /Users/yashtalele/expense_tracker/server/kubernetes.yml
        ignore_errors: true
      - name: Create pods
        ansible.builtin.shell: /usr/local/bin/kubectl create -f /Users/yashtalele/expense_tracker/server/kubernetes.yml
